// Smart Triage System - Hospital Command Center (Neon PostgreSQL)
// https://pris.ly/d/postgresql

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ---------- Enums ----------

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  REVIEW_REQUIRED
}

enum DocumentProcessingStatus {
  UPLOADED
  PROCESSING
  AI_EXTRACTED
  FAILED
}

enum UserRole {
  ADMIN
  TRIAGE_NURSE
  DOCTOR
  COMMAND_CENTER
}

// ---------- Core models ----------

model Patient {
  id                    String    @id @default(uuid())
  name                  String
  age                   Int
  gender                String
  symptoms              String[]
  bloodPressure         String?
  heartRate             Int?
  temperature           Float?
  preExistingConditions String[]
  riskScore             Float?
  riskLevel             RiskLevel
  recommendedDepartment String
  explanation           Json?
  ewsScore              Float?    // Early Warning Score (Phase 3)
  aiDisagreement        Boolean   @default(false) // Phase 2 ensemble
  createdAt             DateTime  @default(now())

  documents UploadedDocument[]
}

model DepartmentLoad {
  id               String   @id @default(uuid())
  departmentName   String   @unique
  currentPatients  Int      @default(0)
  availableDoctors Int      @default(0)
  avgWaitTime      Int      @default(0) // minutes
  avgTreatmentTime Int      @default(15) // minutes per patient (Phase 6)
  bedOccupancy     Int      @default(0) // 0-100 % (Phase 7)
}

model UploadedDocument {
  id                String                   @id @default(uuid())
  patientId         String
  fileUrl           String
  extractedText     String                   @db.Text
  structuredData    Json?
  processingStatus  DocumentProcessingStatus @default(UPLOADED)
  processingError   String?
  createdAt         DateTime                 @default(now())

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
}

// ---------- Organization & Auth ----------

model Organization {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())

  users User[]
}

model User {
  id             String       @id @default(uuid())
  email          String
  passwordHash   String
  name           String
  role           UserRole     @default(TRIAGE_NURSE)
  organizationId  String
  createdAt      DateTime     @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, email])
  @@index([organizationId])
  @@index([email])
}

// ---------- Audit (Phase 1) ----------

model AuditLog {
  id        String   @id @default(uuid())
  action    String
  userRole  String
  patientId String?
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([action])
  @@index([patientId])
  @@index([createdAt])
}
